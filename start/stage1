#!/bin/sh
set -e +a +m +s +i -f

writeEnvironmentVars(){
   if [ -n "$VAR_CONFIG_FILE" ]
   then
      local VAR_CONFIG_DIR="$(/usr/bin/dirname "$VAR_CONFIG_FILE")"
   else
      unset VAR_CONFIG_FILE
   fi
   local IFS=$(echo -en "\n\b")
   local tmp="$(set | grep -E "^VAR_")"
   local vars=""
   local delimiter=""
   for var in $tmp
   do
      vars="$vars$delimiter$var"
      delimiter=$'\n'
   done
   IFS=$(echo -en "")
   echo "$vars" > /environment/vars
}

if [ ! -e "/environment/vars" ]
then
   writeEnvironmentVars
   isFirstRun="true"
fi
exec /usr/bin/env -i /start/stage2 $isFirstRun
