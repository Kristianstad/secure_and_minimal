#!/bin/sh
set -e +a +m +s +i -f

# Passed from stage1:
# -------------------------------------------
# LINUX_USER
# CONFIG_FILE/CONFIG_DIR

# Set by shell:
# -------------------------------------------
# IFS


. /start/common.functions
. /start/stage2.functions

readonly ifs_bak=$IFS

if [ -n "$CONFIG_FILE" ]
then
   CONFIG_DIR="$(/usr/bin/dirname "$CONFIG_FILE")"
fi
readonly CONFIG_FILE
readonly CONFIG_DIR
if [ "$(isFirstRun)" == "true" ]
then
   readonly restart="false"
   env_list="$(listFromFile /environment/runtime)"
   /bin/rm /environment/runtime
   makeAllFromEnvList
   if [ -n "$CONFIG_DIR" ]
   then
      /bin/chown -R $LINUX_USER:root "$CONFIG_DIR"
      /bin/chmod 7770 "$CONFIG_DIR"
      set +f
      /bin/chmod -R ug=rw,o= "$CONFIG_DIR/"*
      set -f
   fi
else
   readonly restart="true"
   env_list="$(listFromFile "$restart_environment")"
fi
#   /bin/chmod -R u=rx,g=rx,o= "$BIN_DIR"      
. "$bin_dir/start.stage3"
