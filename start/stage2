#!/bin/sh
set -e +a +m +s +i -f

# Set by shell:
# -------------------------------------------
# IFS

# Passed from stage1:
# -------------------------------------------
# firstrun

. /start/stage2.functions

readonly ifs_bak=$IFS
if [ "$firstrun" == "true" ]
then
   readFirstrunEnvironment
   if [ -n "$VAR_CONFIG_DIR" ]
   then
      /bin/chown -R $VAR_LINUX_USER:root "$VAR_CONFIG_DIR"
      /bin/chmod 7770 "$VAR_CONFIG_DIR"
      if [ "$(ls -A "$VAR_CONFIG_DIR")" ]
      then
         set +f
         /bin/chmod -R ug=rwX,o= "$VAR_CONFIG_DIR/"*
         set -f
      fi
   fi
   tryRunStage 3
   writeRestartEnvironment
else
   readRestartEnvironment
   tryRunStage 3
fi
executeCommandAsLinuxUser "$VAR_FINAL_COMMAND"
