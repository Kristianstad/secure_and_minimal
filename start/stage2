#!/bin/sh
set -e +a +m +s +i -f

# Passed from stage1:
# -------------------------------------------
# LINUX_USER
# CONFIG_FILE/CONFIG_DIR

# Set by shell:
# -------------------------------------------
# IFS


. /start/common.functions
. /start/stage2.functions

readonly ifs_bak=$IFS

if [ -n "$CONFIG_FILE" ]
then
   CONFIG_DIR="$(/usr/bin/dirname "$CONFIG_FILE")"
fi
readonly CONFIG_FILE
readonly CONFIG_DIR
if [ "$(isFirstrun)" == "true" ]
then
   env_list="$(readFirstrunEnvironment)"
   makeAllFromEnvList
   if [ -n "$CONFIG_DIR" ]
   then
      /bin/chown -R $LINUX_USER:root "$CONFIG_DIR"
      /bin/chmod 7770 "$CONFIG_DIR"
      set +f
      /bin/chmod -R ug=rw,o= "$CONFIG_DIR/"*
      set -f
   fi
else
   env_list="$(readRestartEnvironment)"
fi
. /start/stage3
