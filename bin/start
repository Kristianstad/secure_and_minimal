#!/bin/sh
set -e +a +m +s +i -f

# Set by sudo command:
# -------------------------------------------
# SUDO_USER
# -------------------------------------------

# Could be set in Dockerfile:
# -------------------------------------------
# REV_LINUX_USER
# -------------------------------------------

if [ -z "$SUDO_USER" ]
then
   SUDO_USER="root"
fi
readonly SUDO_USER
readonly BIN_DIR="$(/usr/bin/dirname $0)"
if [ ! -f "$BIN_DIR/start.stage3" ]
then
   echo "Nothing to do! Exiting."
   exit 0
fi
readonly RUNTIME_ENVIRONMENT="/environment/runtime_environment"
if [ -f "$RUNTIME_ENVIRONMENT" ]
then
   if [ -n "$REV_LINUX_USER" ]
   then
      runas="root, $REV_LINUX_USER"
   else
      runas="root"
   fi
   echo "root $(/bin/hostname)=($runas) NOPASSWD: $BIN_DIR/, /bin/, /sbin/, /usr/bin/, /usr/sbin/" > /etc/sudoers.d/docker2
   if [ "$SUDO_USER" != "root" ]
   then
      echo "$SUDO_USER $(/bin/hostname)=(root) NOPASSWD: $BIN_DIR/start" >> /etc/sudoers.d/docker2
   fi
   /usr/bin/env | /bin/grep -i "^REV_" > "$RUNTIME_ENVIRONMENT"
   /usr/bin/env | /bin/grep -i "^BEV_" > "$RUNTIME_ENVIRONMENT"
fi
exec /usr/bin/env -i "$BIN_DIR/start.stage2"
